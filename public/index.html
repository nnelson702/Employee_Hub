<!DOCTYPE html>

<html>

<head>

  <meta charset="UTF-8">

  <meta name="viewport" content="width=device-width, initial-scale=1">

  <base target="_top">

  <style>

    html { font-size:18px; }

    body {

      margin:0; padding:0;

      font-family:Arial,sans-serif;

      font-size:1rem; line-height:1.5;

     
background:url('https://drive.google.com/uc?export=view&id=1v3JhZ-6icq4NHjoFa-I3rvNgUpiLidcs')
repeat;

      background-size:80px 80px;

    }

    #container {

      box-sizing:border-box;

      max-width:480px; margin:auto;

      padding:1rem; background:rgba(255,255,255,0.9);

    }

    label, select, input, textarea, button { font-size:1rem; }

    select, input, textarea {

      width:100%; padding:0.75rem; margin-bottom:1rem;

      border:1px solid #ccc; border-radius:4px;

    }

    .question { margin-bottom:1.5rem; }

    .radios label {

      display:inline-block;

      margin-right:1.5rem;

      cursor:pointer;

    }

    .assign-block {

      margin:0.5rem 0 1rem; padding:0.75rem;

      border:1px solid #ddd; background:#f9f9f9;

    }

    button {

      display:block; width:100%;

      padding:0.75rem; margin:0.75rem 0;

      border:none; border-radius:4px;

      background:#c00; color:#fff;

    }

    button.secondary { background:#555; }

    hr { margin:2rem 0; border-top:1px solid #eee; }

    #main { position:relative; padding-bottom:4rem; }

    button.finish {

      position:fixed; bottom:0; left:0; right:0;

      border-radius:0;

    }

    details summary {

      cursor:pointer; padding:0.5rem 0;

      font-weight:bold; border-bottom:1px solid #ddd;

    }

    details[open] summary { margin-bottom:1rem; }

    #spinner {

      position:fixed; top:0; left:0; right:0; bottom:0;

      background:rgba(255,255,255,0.7);

      display:flex; align-items:center; justify-content:center;

      font-size:1.2rem; z-index:1000;

    }

    .hidden { display:none!important; }

  </style>

</head>

<body>

  <div id="spinner" class="hidden">Loading…</div>

  <div id="container">

    <h2>Shift Readiness Store Walk</h2>

    <div id="step1">

      <label>Store</label>

      <select id="storeSelect" onchange="onWalkTypeChange()">

        <option>-- Select Store --</option>

      </select>

      <label>Walk Type</label>

      <select id="walkType" onchange="onWalkTypeChange()">

        <option>-- Select Walk Type --</option>

        <option>Daily Dept</option>

        <option>Weekly Dept</option>

        <option>Monthly Store Walk</option>

      </select>

      <div id="deptBlock" class="hidden">

        <label>Department</label>

        <select id="deptSelect">

          <option>-- Select Dept --</option>

        </select>

      </div>

      <button onclick="startSession()">Start Walk</button>

    </div>

    <div id="main" class="hidden">

      <h3>Checklist</h3>

      <details open>

        <summary>Checklist (tap to expand)</summary>

        <div id="checklistForm"></div>

      </details>

      <hr>

      <h3>Log Additional Issue</h3>

      <button class="secondary" onclick="showIssueForm()">Log
Issue</button>

      <div id="issueForm" class="hidden">

        <label>Location code</label>

        <input id="locCode" placeholder="e.g. 01L02">

        <label>Category</label>

        <select id="category">

          <option>OUTS/Restock</option>

          <option>Front/Org/Clean</option>

          <option>KUDOS!!!</option>

          <option>POG Compliance</option>

          <option>Safety concern</option>

        </select>

        <label>Comment</label>

        <textarea id="comment" rows="2"></textarea>

        <label>Take Photo</label>

        <input type="file" id="photoInput" accept="image/*"
capture="environment">

        <button class="secondary" onclick="submitIssue()">Submit
Issue</button>

      </div>

      <hr>

      <label>Aisles Reviewed</label>

      <input id="aislesInput" placeholder="e.g. 12-19">

      <label>Send Summary To</label>

      <input id="emailsInput" placeholder="email1@…,email2@…">

      <label>General Comments</label>

      <textarea id="commentsInput" rows="2"></textarea>

      <button class="finish" onclick="endWalk()">Finish Walk & Send
Summary</button>

    </div>

  </div>

  <script>

    var STORES = <?!= JSON.stringify(stores) ?>,

        DEPT_MAP = <?!= JSON.stringify(departmentsMap) ?>;

    function
showSpinner(){document.getElementById('spinner').classList.remove('hidden');}

    function
hideSpinner(){document.getElementById('spinner').classList.add('hidden');}

    function resizeAndUpload(file, maxW, cb) {

      var img = new Image(), reader = new FileReader();

      reader.onload = e=>{

        img.src=e.target.result;

        img.onload=()=>{

          var c=document.createElement('canvas'),

              s=maxW/img.width;

          c.width=maxW; c.height=img.height*s;

          c.getContext('2d').drawImage(img,0,0,c.width,c.height);

          cb(c.toDataURL('image/jpeg',0.7));

        };

      };

      reader.readAsDataURL(file);

    }

    document.addEventListener('DOMContentLoaded',()=>{

      var sel=document.getElementById('storeSelect');

      sel.innerHTML = '<option>-- Select Store --</option>'

        + STORES.map(s=>`<option
value="${s.id}">${s.name}</option>`).join('');

    });

    function onWalkTypeChange(){

      var wt=document.getElementById('walkType').value,

          st=document.getElementById('storeSelect').value,

          db=document.getElementById('deptBlock');

      APP_STATE.walkType=wt; APP_STATE.storeId=st;

      if(/Dept/.test(wt)&&st){

        var arr=DEPT_MAP[st]||[];

        document.getElementById('deptSelect').innerHTML =

          '<option>-- Select Dept --</option>'

          + arr.map(d=>`<option
value="${d.id}">${d.name}</option>`).join('');

        db.classList.remove('hidden');

      } else db.classList.add('hidden');

    }

    function startSession(){

      var dept=document.getElementById('deptSelect').value;

     
if(!APP_STATE.storeId||!APP_STATE.walkType||(/Dept/.test(APP_STATE.walkType)&&!dept)){

        return alert('Select store, walk type, and dept if required.');

      }

      showSpinner();

      google.script.run

        .withSuccessHandler(id=>{

          hideSpinner();

          APP_STATE.sessionId=id;

          document.getElementById('step1').classList.add('hidden');

          document.getElementById('main').classList.remove('hidden');

          loadChecklistItems(dept);

        })

        .withFailureHandler(err=>{

          hideSpinner();

          alert('Error starting walk: '+err.message);

        })

        .startWalk(APP_STATE.walkType,dept,APP_STATE.storeId);

    }

    function loadChecklistItems(deptId){

      var fn = APP_STATE.walkType==='Monthly Store Walk'

               ? 'getAllChecklistItemsForStore'

               : 'getChecklistItemsFor',

          arg=
fn==='getAllChecklistItemsForStore'?APP_STATE.storeId:deptId;

      showSpinner();

      google.script.run

        .withSuccessHandler(items=>{

          hideSpinner();

          APP_STATE.items=items;

          var html='';

          items.forEach((it,i)=>{

            html+=`<div class="question">

              <div>${i+1}. ${it.text}</div>

              <div class="radios">

                <label><input type="radio" name="q${i}" value="Ready">
Ready</label>

                <label><input type="radio" name="q${i}" value="Action
Needed"> Action Needed</label>

              </div>

              <div class="assign-block hidden" data-for="q${i}">

                <input type="text" name="assign_q${i}"
placeholder="Assigned To">

                <textarea name="comment_q${i}" rows="1"
placeholder="Comment"></textarea>

              </div>

            </div>`;

          });

          document.getElementById('checklistForm').innerHTML=html;

          document.querySelectorAll('.radios input').forEach(r=>{

            r.onchange=e=>{

              var b=document.querySelector(

                '.assign-block[data-for="'+e.target.name+'"]'

              );

              b.classList.toggle('hidden',e.target.value!=='Action
Needed');

            };

          });

        })

        .withFailureHandler(err=>{

          hideSpinner();

          alert('Error loading checklist: '+err.message);

        })[fn](arg);

    }

    function showIssueForm(){

      document.getElementById('issueForm').classList.toggle('hidden');

    }

    function submitIssue(){

      var loc=document.getElementById('locCode').value.trim(),

          cat=document.getElementById('category').value,

          com=document.getElementById('comment').value.trim(),

          file=document.getElementById('photoInput').files[0];

      if(!loc||!cat) return alert('Location and category required.');

      function logWith(photoId){

        showSpinner();

        google.script.run

          .withSuccessHandler(()=>{

            hideSpinner();

            alert('Issue logged.');

           
document.getElementById('issueForm').classList.add('hidden');

           
['locCode','comment','photoInput'].forEach(id=>document.getElementById(id).value='');

            document.getElementById('category').selectedIndex=0;

          })

          .withFailureHandler(err=>{

            hideSpinner();

            alert('Error logging issue: '+err.message);

          })

          .logIssue(APP_STATE.sessionId,loc,cat,com,photoId||'');

      }

      if(file){

        resizeAndUpload(file,800,dataUrl=>{

          showSpinner();

          google.script.run

            .withSuccessHandler(logWith)

            .withFailureHandler(err=>{

              hideSpinner();

              alert('Error uploading image: '+err.message);

            })

            .saveImage(dataUrl,file.name);

        });

      } else logWith('');

    }

    function endWalk(){

      var responses=APP_STATE.items.map((it,i)=>{

        var sel=document.querySelector('input[name="q'+i+'"]:checked');

        return {

          itemId:     it.id,

          answer:     sel?sel.value:'',

          assignedTo: sel&&sel.value==='Action Needed'

            ?
document.querySelector('input[name="assign_q'+i+'"]').value.trim() : '',

          comment:    sel&&sel.value==='Action Needed'

            ?
document.querySelector('textarea[name="comment_q'+i+'"]').value.trim() :
''

        };

      });

      var ais=document.getElementById('aislesInput').value.trim(),

          ems=document.getElementById('emailsInput').value.trim(),

          cm =document.getElementById('commentsInput').value.trim();

      showSpinner();

      google.script.run

        .withSuccessHandler(()=>{

          google.script.run

            .withSuccessHandler(()=>{

              hideSpinner();

              alert('Walk complete! Summary sent.');

              location.reload();

            })

            .withFailureHandler(err=>{

              hideSpinner();

              alert('Error sending summary: '+err.message);

            })

            .endWalk(APP_STATE.sessionId,ais,ems,cm);

        })

        .withFailureHandler(err=>{

          hideSpinner();

          alert('Error saving checklist: '+err.message);

        })

        .saveChecklistResponses(APP_STATE.sessionId,responses);

    }

    var APP_STATE={ sessionId:null, storeId:null, walkType:null,
items:[] };

  </script>

</body>

</html>
